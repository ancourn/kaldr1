<source>
  @type tail
  path /var/log/kaldrix/*.log
  pos_file /var/log/fluentd/kaldrix.log.pos
  tag kaldrix.*
  format json
  time_format %Y-%m-%dT%H:%M:%S.%L%z
</source>

<source>
  @type tail
  path /var/log/nginx/*.log
  pos_file /var/log/fluentd/nginx.log.pos
  tag nginx.*
  format /^(?<remote_addr>[^ ]*) - (?<remote_user>[^ ]*) \[(?<time_local>[^\]]*)\] "(?<method>[^ ]*) (?<path>[^ ]*) (?<protocol>[^ ]*)" (?<status>[^ ]*) (?<body_bytes_sent>[^ ]*) "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)"(?<elapsed_time>[^ ]*)?$/
  time_format %d/%b/%Y:%H:%M:%S %z
</source>

<source>
  @type tail
  path /var/log/postgresql/*.log
  pos_file /var/log/fluentd/postgresql.log.pos
  tag postgresql.*
  format /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} UTC) \[(?<pid>\d+)\] (?<level>\w+):  (?<message>.*)$/
  time_format %Y-%m-%d %H:%M:%S.%L %Z
</source>

<source>
  @type tail
  path /var/log/redis/*.log
  pos_file /var/log/fluentd/redis.log.pos
  tag redis.*
  format /^(?<time>\d+:\d+:\d+) (?<level>\d+) (?<message>.*)$/
  time_format %H:%M:%S
</source>

<match kaldrix.**>
  @type loki
  url http://loki:3100/loki/api/v1/push
  extract_kubernetes_labels true
  labels:
    job: kaldrix
    component: backend
    environment: production
  <label>
    level ${record['level'] || 'info'}
    service ${record['service'] || 'unknown'}
  </label>
  remove_keys level,service
</match>

<match nginx.**>
  @type loki
  url http://loki:3100/loki/api/v1/push
  extract_kubernetes_labels true
  labels:
    job: nginx
    component: proxy
    environment: production
  <label>
    status ${record['status']}
    method ${record['method']}
  </label>
  remove_keys status,method
</match>

<match postgresql.**>
  @type loki
  url http://loki:3100/loki/api/v1/push
  extract_kubernetes_labels true
  labels:
    job: postgresql
    component: database
    environment: production
  <label>
    level ${record['level']}
    pid ${record['pid']}
  </label>
  remove_keys level,pid
</match>

<match redis.**>
  @type loki
  url http://loki:3100/loki/api/v1/push
  extract_kubernetes_labels true
  labels:
    job: redis
    component: cache
    environment: production
  <label>
    level ${record['level']}
  </label>
  remove_keys level
</match>

<match **>
  @type stdout
  <format>
    @type single_value
    message_key message
  </format>
</match>